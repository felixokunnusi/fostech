{# templates/quiz/history.html #}
{% extends "base.html" %}

{% block content %}
<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Exam History</h3>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('dashboard.index') }}">Back to Dashboard</a>
      <a class="btn btn-outline-primary" href="{{ url_for('quiz.choose_level') }}">Start New Quiz</a>
    </div>
  </div>

  <!-- Filters -->
  <form class="card mb-3" method="get">
    <div class="card-body d-flex flex-wrap gap-3 align-items-end">
      <div style="min-width: 200px;">
        <label class="form-label mb-1">Mode</label>
        <select class="form-select" name="mode">
          <option value="" {% if not mode %}selected{% endif %}>All</option>
          <option value="exam" {% if mode == 'exam' %}selected{% endif %}>Exam</option>
          <option value="trial" {% if mode == 'trial' %}selected{% endif %}>Trial</option>
        </select>
      </div>

      <div style="min-width: 240px;">
        <label class="form-label mb-1">Band</label>
        <input class="form-control"
               name="band"
               value="{{ band }}"
               placeholder="e.g. 1-4 or confirmation">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">Filter</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('quiz.history') }}">Reset</a>
      </div>
    </div>
  </form>

  <!-- Summary -->
  <div class="row g-2 mb-3">
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Overall Average</div>
          <div class="fs-4">{{ overall_avg }}%</div>
          <small class="text-muted">Submitted attempts only</small>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Overall Best</div>
          <div class="fs-4">{{ overall_best }}%</div>
          <small class="text-muted">Submitted attempts only</small>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="text-muted">Submitted Attempts</div>
          <div class="fs-4">{{ overall_count }}</div>
          <small class="text-muted">Filtered by Mode/Band</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend -->
  <div class="card mb-3">
    <div class="card-body">
      <div class="fw-semibold mb-2">Trend (Last {{ trend_points|length }})</div>
      <canvas id="trendCanvas" height="100"></canvas>
      <div class="d-flex flex-wrap gap-2 mt-2">
        {% for p in trend_points %}
          <span class="badge bg-light text-dark">{{ p.label }}: {{ p.percent }}%</span>
        {% endfor %}
      </div>
      <small class="text-muted d-block mt-2">
        Trend uses submitted attempts (completed exams/trials).
      </small>
    </div>
  </div>

  <!-- Attempts table -->
  <div class="card">
    <div class="card-body">
      <div class="fw-semibold mb-2">Attempts</div>

      {% if rows|length == 0 %}
        <div class="alert alert-info mb-0">No attempts found for the selected filters.</div>
      {% else %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Started</th>
                <th>Status</th>
                <th>Mode</th>
                <th>Band</th>
                <th>Score</th>
                <th>%</th>
                <th>Duration</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>

            <tbody>
              {% for r in rows %}
                <tr>
                  <td>
                    {% if r.started_at %}
                      {{ r.started_at.strftime("%Y-%m-%d %H:%M") }}
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td>
                    {% if r.is_submitted %}
                      <span class="badge bg-success">Submitted</span>
                      {% if r.completed_at %}
                        <div class="text-muted" style="font-size: 12px;">
                          {{ r.completed_at.strftime("%Y-%m-%d %H:%M") }}
                        </div>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-warning text-dark">In progress</span>
                      {% if r.mode == 'exam' and r.completed_at is none %}
                        <div class="text-muted" style="font-size: 12px;">
                          Not submitted yet
                        </div>
                      {% endif %}
                    {% endif %}
                  </td>

                  <td>{{ r.mode }}</td>
                  <td>{{ r.band }}</td>

                  <td>
                    {% if r.is_submitted %}
                      {{ r.score }} / {{ r.total }}
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td>
                    {% if r.is_submitted %}
                      {{ r.percent }}%
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td>
                    {% if r.duration_min is not none %}
                      {{ r.duration_min }} min
                    {% else %}
                      —
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {% if r.is_submitted %}
                      <a class="btn btn-outline-secondary btn-sm"
                         href="{{ url_for('quiz.result', session_id=r.id) }}">
                        View
                      </a>
                    {% else %}
                      <a class="btn btn-primary btn-sm"
                         href="{{ url_for('quiz.take', session_id=r.id, q=1) }}">
                        Resume
                      </a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="text-muted">
            Page {{ pagination.page }} of {{ pagination.pages if pagination.pages else 1 }}
          </div>

          <div class="d-flex gap-2">
            {% if pagination.has_prev %}
              <a class="btn btn-outline-secondary btn-sm"
                 href="{{ url_for('quiz.history', page=pagination.prev_num, mode=mode, band=band) }}">
                Prev
              </a>
            {% endif %}
            {% if pagination.has_next %}
              <a class="btn btn-outline-secondary btn-sm"
                 href="{{ url_for('quiz.history', page=pagination.next_num, mode=mode, band=band) }}">
                Next
              </a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

</div>

<script>
  (function () {
    const points = {{ trend_points|tojson }};
    const canvas = document.getElementById("trendCanvas");
    const ctx = canvas.getContext("2d");

    // Resize to container width (crisp line)
    const dpr = window.devicePixelRatio || 1;
    const cssW = canvas.clientWidth || canvas.parentElement.clientWidth;
    const cssH = parseInt(canvas.getAttribute("height"), 10);

    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.scale(dpr, dpr);

    const w = cssW;
    const h = cssH;

    ctx.clearRect(0, 0, w, h);

    if (!points || points.length === 0) return;

    const pad = 12;
    const innerW = w - pad * 2;
    const innerH = h - pad * 2;

    const minV = 0;
    const maxV = 100;

    const x = (i) => pad + (innerW * (points.length === 1 ? 0 : i / (points.length - 1)));
    const y = (v) => {
      const t = (v - minV) / (maxV - minV);
      return pad + innerH * (1 - t);
    };

    // baseline grid
    ctx.globalAlpha = 0.2;
    [0, 25, 50, 75, 100].forEach((v) => {
      ctx.beginPath();
      ctx.moveTo(pad, y(v));
      ctx.lineTo(w - pad, y(v));
      ctx.stroke();
    });
    ctx.globalAlpha = 1;

    // trend line
    ctx.beginPath();
    points.forEach((p, i) => {
      const px = x(i);
      const py = y(p.percent);
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.lineWidth = 2;
    ctx.stroke();

    // dots
    points.forEach((p, i) => {
      ctx.beginPath();
      ctx.arc(x(i), y(p.percent), 3, 0, Math.PI * 2);
      ctx.fill();
    });

    // labels (first + last only, to keep it clean)
    ctx.font = "12px sans-serif";
    ctx.fillText(points[0].label, pad, h - 4);
    ctx.fillText(points[points.length - 1].label, w - pad - 60, h - 4);
  })();
</script>
{% endblock %}
